<html>
	<head>
		<link rel="stylesheet" href="cssReset.css">
		<script src="phaser.js"></script>
		<style>

		</style>
	</head>
	<body>
		<script>
			const canvasWidth = 1280;
			const canvasHeight = 720;

			const game = new Phaser.Game(1280, 720, Phaser.AUTO, '', { preload: preload, create: create, update: update });

			var daysSinceStart = 0;
			const gameState = {
				happiness: 20,
				money: 250000,
				connections: 0,
				daysTillDeath: 365,
				injured: false,
				sport: undefined,
				lossRate: 1
			};

			var activities;
			var sports;
			var investments;

			function preload() {
				game.load.image('IDLogo', './VodLogo.png');
				game.load.image('Background', './Background.png');
				game.load.image('Grid', './GridBase.png');
				game.load.json('activities', './activities.json');
				game.load.json('sports', './sports.json');
				game.load.json('investments', './investments.json');
			}
			/**
				"stockOption1": {
					"cost": 10,
					"extendLife": 0,
					"name": "Stock Option 1",
					"balance": 0,
					"baseInterestRate": 0.05,
					"risk": 0.2
				},
			**/
			function invest(option, amount) {
				let x = investments[option];
				gameState.money -= x.cost * amount;
				x.balance += x.cost * amount;
			}

			function withdraw(option, amount) {
				let x = investments[option];
				gameState.money += Math.min(x.balance, amount);
				x.balance -= Math.min(x.balance, amount);
			}

			/**
				"visitBar": {
					"cost": 10,
					"novelty": 2,
					"baseHappiness": 0,
					"social": 3,
					"numCompleted": 0,
					"time": 1,
					"extendLife": -1,
					"rewarding": 2,
					"name": "Visit and Meet People at Local Bar"
				}

				HappinessFromActivity = Happiness Value + (Novelty / Number of times completed)
																+ (Number of times completed / Connections || 0)
			**/

			function performActivity(activity) {
				let x = activities[activity];
				gameState.money -= x.cost;
				let happiness = x.baseHappiness
												+ (x.novelty / (x.numCompleted + 1))
												+ (x.numCompleted / x.social)
												+ (x.rewarding ? (x.numCompleted/4) / x.rewarding : 0);
				if(x.deviation) {
					let random = Math.random();
					happiness += (random < x.devBounds[0] ? -x.deviation : (random > x.devBounds[1] ? x.deviation : 0));
				}
				gameState.happiness += happiness;
				++x.numCompleted;
				passTime(x.time);
			}

			/**
				"soccer": {
					"cost": 5,
					"novelty": 3,
					"baseHappiness": 2,
					"social": 3,
					"numCompleted": 0,
					"time": 1,
					"extendLife": 0.25,
					"rewarding": 5,
					"injuryChance": 0.05,
					"name": "Soccer"
				},
			**/

			function playSport(sport) {
				let x = sports[sport];
				gameState.money -= x.cost;
				if(gameState.injured || Math.random() < x.injuryChance) {
					gameState.injured = true;
				} else {
					let happiness = x.baseHappiness
													+ (x.novelty / (x.numCompleted + 1))
													+ (x.numCompleted / x.social)
													+ (x.rewarding ? (x.numCompleted/4) / x.rewarding : 0);
					gameState.happiness += happiness;
				}
				++x.numCompleted;
				passTime(1);
			}

			function passTime(days) {
				++daysSinceStart;
				--gameState.daysTillDeath;
				gameState.lossRate = 300 / gameState.daysTillDeath;
				gameState.happiness -= gameState.lossRate / days;
				if(gameState.happiness > 1000) {
					console.log(daysSinceStart);
				}
				gameState.daysTillDeath += investments['research'].extendLife * (investments['research'].balance / investments['research'].cost);
				investments['research'].balance = 0;
				for(let i = 1, l = Object.keys(investments).length; i < l; ++i) {
					let key = Object.keys(investments)[i];
					if(!investments[key].permanent) {
						investments[key].balance += investments[key].balance * (Math.random() - investments[key].risk) * investments[key].baseInterestRate;
					}
				}
				if(days > 1) {
					passTime(days - 1);
				}
			}

			function inside(point, vs) {
				var x = point[0], y = point[1];
				var inside = false;
				for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
						var xi = vs[i][0], yi = vs[i][1];
						var xj = vs[j][0], yj = vs[j][1];

						var intersect = ((yi > y) != (yj > y))
								&& (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
						if (intersect) inside = !inside;
				}
				return inside;
			};

			var frameNo = 0;

			function create() {
				activities = game.cache.getJSON('activities');
				sports = game.cache.getJSON('sports');
				investments = game.cache.getJSON('investments');
				game.stage.backgroundColor = 0x80E0F1;
				background = game.add.sprite(0, 0, 'Background');
				background.width = canvasWidth;
				background.height = canvasHeight;
				grid = game.add.sprite(0, 0, 'Grid');
				grid.width = canvasWidth;
				grid.height = canvasHeight;
				centerPoint = game.add.graphics();
				centerPoint.beginFill(0xff0000);
				centerPoint.drawCircle(0, 0, 5);
				centerPoint.endFill();
				logo = game.add.sprite(0, 0, 'IDLogo');
				logo.age = 120;
				leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
				rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
				upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
				downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
			}

			var init = false;


			function runSim() {
				if(!init) {

					init = true;
				}
				iterate();
			}

		var activeX = -1;
		var activeY = -1;

		function iterate() {
			frameNo++;
			for(let x = 0; x < 10; ++x) {
				for(let y = 0; y < 10; ++y) {
					let startX = 640 + 50.4*x - 50.4*y;
					let startY = 233 + 22.6*y + 22.6*x;
					let points = [
						[startX, startY],
						[startX + 50.4, startY + 22.6],
						[startX, startY + 45.2],
						[startX - 50.4, startY + 22.6],
						[startX, startY]
					];
					if(inside([game.input.mousePointer.clientX, game.input.mousePointer.clientY], points)) {
						activeX = x;
						activeY = y;
					}
				}
			}
			if(game.input.mousePointer.isDown) {
				console.log([game.input.mousePointer.clientX, game.input.mousePointer.clientY]);
				console.log([activeX, activeY]);
			}
			game.stage.backgroundColor = Phaser.Color.interpolateColor(0x80E0F1, 0x2C4A4F, 900, Math.min(frameNo, 900));
		}

			var logoVisible = true;

			function update() {
				if(logoVisible) {
					if(logo.age > -1) {
						logo.age--;
						if(logo.age < 31) {
							logo.alpha = logo.age / 30;
						}
					} else if(logo.age == -1) {
						logo = null;
						logoVisible = false;
					}
				} else {
					runSim();
				}
			}
		</script>
	</body>
</html>
